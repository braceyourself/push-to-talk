---
phase: 07-nonverbal-system-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - live_session.py
  - clip_factory.py
  - audio/fillers/nonverbal/
  - audio/fillers/pool.json
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "Barge-in trailing filler plays an acknowledgment clip instead of silently returning None"
    - "No nonverbal clip generation code remains in clip_factory.py"
    - "No unused nonverbal audio files exist on disk"
    - "FILL-02 requirement text accurately describes acknowledgment-phrase behavior"
    - "Clip factory still generates and manages acknowledgment clips correctly"
  artifacts:
    - path: "live_session.py"
      provides: "Fixed barge-in trailing filler and updated docstring"
      contains: '_pick_filler("acknowledgment")'
    - path: "clip_factory.py"
      provides: "Acknowledgment-only clip factory (nonverbal code removed)"
      exports: ["top_up_ack_pool", "daemon_mode", "main", "generate_clip", "evaluate_clip"]
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated FILL-02 requirement text"
      contains: "acknowledgment phrase audio clips"
  key_links:
    - from: "live_session.py (_handle_barge_in)"
      to: "_pick_filler"
      via: "category argument"
      pattern: '_pick_filler\("acknowledgment"\)'
    - from: "clip_factory.py (daemon_mode)"
      to: "top_up_ack_pool"
      via: "direct call (no top_up_pool)"
      pattern: "top_up_ack_pool"
    - from: "clip_factory.py (main)"
      to: "top_up_ack_pool"
      via: "direct call (no top_up_pool)"
      pattern: "top_up_ack_pool"
---

<objective>
Fix the broken barge-in trailing filler and remove all orphaned nonverbal filler code, assets, and references left behind when Phase 6 replaced the nonverbal system with acknowledgment phrases.

Purpose: Phase 6 dropped nonverbal fillers (Piper TTS can't produce natural hums/breaths) but left behind orphaned code that wastes CPU on session start and a broken barge-in consumer that silently skips the trailing filler. This plan closes the last v1.1 gaps.

Output: Clean clip_factory.py with only acknowledgment code, working barge-in trailing filler, no orphaned files on disk, and accurate documentation.
</objective>

<execution_context>
@/home/ethan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ethan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nonverbal-system-cleanup/07-RESEARCH.md
@clip_factory.py
@live_session.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix barge-in filler and clean live_session.py</name>
  <files>live_session.py</files>
  <action>
Two surgical changes in live_session.py:

1. Line 260 — Update _spawn_clip_factory docstring:
   Change: `"""Spawn the clip factory to top up the non-verbal filler pool."""`
   To:     `"""Spawn the clip factory to top up the acknowledgment filler pool."""`

2. Lines 1828-1830 — Fix barge-in trailing filler:
   Change: `# 9. Play a trailing non-verbal filler clip for naturalness`
   To:     `# 9. Play a trailing acknowledgment filler clip for naturalness`
   Change: `clip = self._pick_filler("nonverbal")`
   To:     `clip = self._pick_filler("acknowledgment")`

This is the critical bug fix: _pick_filler("nonverbal") currently returns None because Phase 6 removed nonverbal clips from the loading path. Changing to "acknowledgment" makes the trailing filler actually play a clip after barge-in, matching the pre-response and pre-tool filler behavior.

Do NOT change anything else in live_session.py. The acknowledgment system works correctly.
  </action>
  <verify>
Run: `python -c "import live_session; print('import OK')"` to verify no syntax errors.
Grep for any remaining "nonverbal" references: `grep -n 'nonverbal' live_session.py` should return zero results.
Grep for the fix: `grep -n '_pick_filler' live_session.py` should show "acknowledgment" at the barge-in call site.
  </verify>
  <done>
_pick_filler("acknowledgment") is called in the barge-in handler. Docstring updated. No "nonverbal" string references remain in live_session.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove nonverbal code from clip_factory.py, delete assets, update docs</name>
  <files>clip_factory.py, audio/fillers/nonverbal/, audio/fillers/pool.json, .planning/REQUIREMENTS.md</files>
  <action>
**Part A: Clean clip_factory.py** — Remove nonverbal-only code while preserving the working acknowledgment system.

Items to REMOVE (constants):
- `CLIP_DIR` (line 36) — nonverbal directory path
- `POOL_META` (line 37) — nonverbal pool.json path
- `POOL_SIZE_CAP` (line 39) — nonverbal cap
- `MIN_POOL_SIZE` (line 40) — nonverbal min
- `PROMPTS` (line 45) — nonverbal prompt list ("um", "uh huh", etc.)

Items to REMOVE (functions):
- `random_synthesis_params()` (lines 81-88) — nonverbal param generator
- `save_clip()` (lines 219-221) — nonverbal-specific save wrapper
- `load_pool_meta()` (lines 245-247) — nonverbal-specific meta loader
- `save_pool_meta()` (lines 250-252) — nonverbal-specific meta writer
- `rotate_pool()` (lines 277-279) — nonverbal-specific rotation wrapper
- `top_up_pool()` (lines 362-365) — nonverbal pool top-up

Items to UPDATE:
- Module docstring (lines 2-9): Remove all references to "Non-verbal fillers (hums, breaths)". Describe the file as acknowledgment clip factory only.
- `evaluate_clip()` (line 140): Change default parameter from `category: str = "nonverbal"` to `category: str = "acknowledgment"`. Remove "nonverbal" from the docstring. Remove the `else` branch (lines 173-179) that checks nonverbal thresholds — the function should only have the acknowledgment branch. Keep the structure clean: just check acknowledgment thresholds directly without the if/else.
- `daemon_mode()` (line 383): Remove the `top_up_pool()` call. Keep only `top_up_ack_pool()`.
- `main()` (line 395): Change argparse description from "Non-verbal filler clip factory" to "Acknowledgment clip factory". Remove `top_up_pool()` call on line 412. Keep only `top_up_ack_pool()`.

Items to KEEP (do NOT remove these shared helpers):
- `_top_up()`, `_load_meta()`, `_save_meta()`, `_rotate_pool()` — generic helpers used by acknowledgment system
- `generate_clip()`, `evaluate_clip()`, `_next_filename()`, `save_clip_to()` — shared utilities
- `PIPER_CMD`, `PIPER_MODEL`, `SAMPLE_RATE`, `MAX_CONSECUTIVE_FAILURES` — shared constants
- All ACK_* constants and `random_ack_params()`, `top_up_ack_pool()` — the active system

**Part B: Delete nonverbal assets from disk**

The nonverbal WAV files on disk are UNTRACKED (the old git-tracked ones were removed in commit 4ab20a9; these are regenerated by the clip factory). Delete them from disk:
- `rm -rf audio/fillers/nonverbal/` (10 untracked WAV files)

The `pool.json` file IS git-tracked. Remove it:
- `git rm audio/fillers/pool.json`

**Part C: Update FILL-02 requirement**

In `.planning/REQUIREMENTS.md`, line 52, change:
```
- [x] **FILL-02**: Live session uses only non-verbal canned audio clips as fillers (breaths, hums, etc.)
```
To:
```
- [x] **FILL-02**: Live session uses only acknowledgment phrase audio clips as fillers (e.g., "let me check that", "one sec")
```
  </action>
  <verify>
1. Syntax check: `python -c "import clip_factory; print('import OK')"` passes
2. No nonverbal references in code: `grep -n 'nonverbal' clip_factory.py` returns zero results (except possibly log messages in generic _top_up that use the category variable, which is fine)
3. Removed functions don't exist: `python -c "import clip_factory; clip_factory.top_up_pool()"` raises AttributeError
4. Acknowledgment system intact: `python -c "import clip_factory; print(clip_factory.top_up_ack_pool.__doc__)"` prints the docstring
5. evaluate_clip default is acknowledgment: `python -c "import clip_factory; import inspect; sig = inspect.signature(clip_factory.evaluate_clip); print(sig)"` shows `category='acknowledgment'`
6. No nonverbal files on disk: `ls audio/fillers/nonverbal/ 2>&1` shows "No such file or directory"
7. pool.json removed from git: `git ls-files audio/fillers/pool.json` returns empty
8. FILL-02 updated: `grep 'FILL-02' .planning/REQUIREMENTS.md` shows "acknowledgment phrase audio clips"
  </verify>
  <done>
clip_factory.py contains only acknowledgment clip code. No nonverbal constants, functions, or branches remain. The nonverbal directory and pool.json are gone from disk and git. FILL-02 requirement text accurately describes the current behavior.
  </done>
</task>

</tasks>

<verification>
1. `python -c "import live_session; import clip_factory; print('Both modules import cleanly')"` — no syntax errors
2. `grep -rn 'nonverbal' live_session.py clip_factory.py` — zero results in both files
3. `grep -n '_pick_filler.*acknowledgment' live_session.py` — shows the barge-in fix
4. `python -c "import clip_factory; print([x for x in dir(clip_factory) if not x.startswith('_')])"` — should NOT contain: top_up_pool, save_clip, load_pool_meta, save_pool_meta, rotate_pool, random_synthesis_params
5. `ls audio/fillers/nonverbal/ 2>&1` — directory does not exist
6. `git ls-files audio/fillers/pool.json` — empty (removed from git)
7. `grep 'FILL-02' .planning/REQUIREMENTS.md` — shows "acknowledgment phrase"
</verification>

<success_criteria>
- Barge-in trailing filler calls _pick_filler("acknowledgment") instead of _pick_filler("nonverbal")
- clip_factory.py has zero nonverbal-specific constants, functions, or code branches
- evaluate_clip() defaults to "acknowledgment" category with no nonverbal else-branch
- daemon_mode() and main() call only top_up_ack_pool(), not top_up_pool()
- No nonverbal WAV files exist on disk
- pool.json removed from git tracking
- FILL-02 requirement text matches actual behavior
- Both Python modules import without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-nonverbal-system-cleanup/07-01-SUMMARY.md`
</output>
