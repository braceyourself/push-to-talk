---
phase: 06-polish-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - live_session.py
  - indicator.py
autonomous: true

must_haves:
  truths:
    - "Throat clearing and coughs are not transcribed as words"
    - "Low-confidence Whisper segments (hallucinated text on noise) are filtered out"
    - "Repetitive hallucination patterns (high compression ratio) are filtered out"
    - "Overlay briefly flashes when audio is heard but rejected by STT"
    - "Legitimate quiet speech is not over-filtered"
  artifacts:
    - path: "live_session.py"
      provides: "Multi-layer Whisper segment filtering in _whisper_transcribe"
      contains: "avg_logprob"
    - path: "indicator.py"
      provides: "STT rejection flash in LiveOverlayWidget"
      contains: "_flash_rejection"
  key_links:
    - from: "live_session.py"
      to: "indicator.py"
      via: "_set_status('stt_rejected') -> STATUS_FILE -> check_status -> update_status -> _flash_rejection"
      pattern: "stt_rejected"
---

<objective>
Add multi-layer Whisper segment filtering (logprob confidence, compression ratio) alongside existing no_speech_prob, and add a brief visual rejection flash in the overlay when STT rejects non-speech audio.

Purpose: Reduce false STT triggers from throat clearing, coughs, and ambient noise — the user's primary annoyance — while keeping a balanced sensitivity that doesn't reject legitimate speech. The visual indicator lets the user know their audio was heard but filtered, rather than appearing to silently ignore them.

Output: Enhanced _whisper_transcribe with 3-layer filtering, stt_rejected overlay flash.
</objective>

<execution_context>
@/home/ethan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ethan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-verification/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-layer Whisper segment filtering</name>
  <files>live_session.py</files>
  <action>
  Enhance the `_whisper_transcribe` method (around line 739) to add two supplementary filters alongside the existing `no_speech_prob` check:

  1. **avg_logprob filter (Layer 2)**: After the no_speech_prob check, add: if `avg_logprob < -1.0`, reject the segment and log it. Low avg_logprob means Whisper is not confident in the transcription — this catches coughs/throat clears that have acoustic energy (so no_speech_prob is low ~0.3-0.4) but produce gibberish text.

  2. **compression_ratio filter (Layer 3)**: After logprob, add: if `compression_ratio > 2.4`, reject the segment and log it. High compression means repetitive hallucinated text ("thank you thank you thank you") which Whisper produces on sustained noise.

  3. **stt_rejected status**: When ALL segments are rejected (the `kept` list is empty but `segments` was non-empty), call `self._set_status("stt_rejected")` so the overlay can show a brief flash. This uses the existing simple string status mechanism — no JSON metadata needed.

  4. **Logging**: Each rejection layer should print a diagnostic line with the metric value and first 40 chars of rejected text, matching the existing format: `print(f"STT: Rejected (logprob={avg_logprob:.2f}): \"{text[:40]}\"", flush=True)`

  Current code at line 767:
  ```python
  kept = [s["text"] for s in segments if s.get("no_speech_prob", 0) < 0.6]
  ```

  Replace with per-segment loop:
  ```python
  kept = []
  for s in segments:
      no_speech = s.get("no_speech_prob", 0)
      avg_logprob = s.get("avg_logprob", 0)
      compression = s.get("compression_ratio", 0)
      text = s.get("text", "").strip()

      # Layer 1: no_speech_prob (existing threshold)
      if no_speech >= 0.6:
          print(f"STT: Rejected (no_speech={no_speech:.2f}): \"{text[:40]}\"", flush=True)
          continue

      # Layer 2: low transcription confidence
      if avg_logprob < -1.0:
          print(f"STT: Rejected (logprob={avg_logprob:.2f}): \"{text[:40]}\"", flush=True)
          continue

      # Layer 3: repetitive hallucination pattern
      if compression > 2.4:
          print(f"STT: Rejected (compression={compression:.2f}): \"{text[:40]}\"", flush=True)
          continue

      kept.append(text)

  text = "".join(kept).strip()
  if not kept and segments:
      # All segments rejected — signal to overlay
      self._set_status("stt_rejected")
      rejected_text = "".join(s.get("text", "") for s in segments).strip()
      print(f"STT: All segments rejected: \"{rejected_text[:60]}\"", flush=True)
  ```

  Keep the existing hallucination phrase list and energy gate in _stt_stage untouched — those are separate defense layers that remain valid.
  </action>
  <verify>
  Run `python -c "import live_session; print('import ok')"` to verify no syntax errors.
  Grep for `avg_logprob` and `compression_ratio` in live_session.py to confirm the new filters exist.
  Grep for `stt_rejected` in live_session.py to confirm the status emission.
  </verify>
  <done>_whisper_transcribe filters segments on 3 layers (no_speech_prob >= 0.6, avg_logprob < -1.0, compression_ratio > 2.4), logs each rejection with its metric, and emits stt_rejected status when all segments are rejected.</done>
</task>

<task type="auto">
  <name>Task 2: Add STT rejection flash to overlay</name>
  <files>indicator.py</files>
  <action>
  Add handling for the `stt_rejected` status in `LiveOverlayWidget`:

  1. **In `update_status` method** (around line 2027): Before the existing status update logic, check if status is `stt_rejected`. If so, call `self._flash_rejection()` and return early — do NOT update `self.status` or append to `self.status_history` (rejection is a transient visual cue, not a state transition).

  ```python
  def update_status(self, status):
      if status == 'stt_rejected':
          self._flash_rejection()
          return
      # ... existing logic ...
  ```

  2. **Add `_flash_rejection` method** to LiveOverlayWidget:
  ```python
  def _flash_rejection(self):
      """Brief visual indicator that audio was filtered."""
      self._rejection_flash = True
      self.queue_draw()
      GLib.timeout_add(300, self._clear_rejection_flash)

  def _clear_rejection_flash(self):
      self._rejection_flash = False
      self.queue_draw()
      return False  # Don't repeat the timer
  ```

  3. **Initialize `_rejection_flash`** in `__init__` (after `self.expanded = False`, around line 1863):
  ```python
  self._rejection_flash = False
  ```

  4. **Render the flash in `on_draw`** (around line 1956-1962, in the dot drawing section): When `self._rejection_flash` is True, draw the status dot with reduced opacity (0.3 instead of 1.0) to create a visible "dim" effect. This is subtle but noticeable — the dot briefly dims and recovers.

  ```python
  # Draw status dot
  dot_x = 22
  dot_y = self.OVERLAY_HEIGHT / 2
  dot_color = self.DOT_COLORS.get(self.status, self.DOT_COLORS['idle'])
  dot_alpha = 0.3 if self._rejection_flash else 1.0
  cr.set_source_rgba(dot_color[0], dot_color[1], dot_color[2], dot_alpha)
  cr.arc(dot_x, dot_y, self.DOT_RADIUS, 0, 2 * PI)
  cr.fill()
  ```

  This approach is minimal — a brief dim of the existing dot, no new UI elements. The 300ms duration is short enough to not be distracting but long enough to notice.
  </action>
  <verify>
  Grep for `_flash_rejection` in indicator.py to confirm the method exists.
  Grep for `stt_rejected` in indicator.py to confirm the handler exists.
  Grep for `_rejection_flash` in indicator.py to confirm initialization and render logic.
  </verify>
  <done>Overlay dims the status dot for 300ms when stt_rejected status is received, without changing the displayed status or adding to history. The flash is transient and non-disruptive.</done>
</task>

</tasks>

<verification>
1. `python -c "import live_session; print('ok')"` — no import errors
2. `python -c "import indicator; print('ok')"` — no import errors (may need display, so syntax check via `python -c "import ast; ast.parse(open('indicator.py').read()); print('syntax ok')"`)
3. Grep confirms: `avg_logprob` in live_session.py, `_flash_rejection` in indicator.py, `stt_rejected` in both files
</verification>

<success_criteria>
- _whisper_transcribe has 3-layer segment filtering with diagnostic logging
- stt_rejected status emitted when all segments are rejected
- Overlay handles stt_rejected with a 300ms dot dim flash
- No changes to existing hallucination phrase list or energy gate (those are separate layers)
- No regressions in normal speech transcription flow
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-verification/06-01-SUMMARY.md`
</output>
