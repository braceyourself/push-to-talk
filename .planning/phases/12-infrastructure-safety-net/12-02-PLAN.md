---
phase: 12-infrastructure-safety-net
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - config.yaml
  - push-to-talk.py
autonomous: true

must_haves:
  truths:
    - "deepgram-sdk is pinned to >=5.3,<6.0 in requirements.txt"
    - "Deepgram API key is loaded from environment or config file at startup"
    - "Config file has new Deepgram-specific settings (idle_timeout, sleep_timeout)"
    - "faster-whisper remains in requirements.txt as fallback dependency"
  artifacts:
    - path: "requirements.txt"
      provides: "Updated dependency with deepgram-sdk version pin"
      contains: "deepgram-sdk>=5.3,<6.0"
    - path: "push-to-talk.py"
      provides: "Deepgram API key loading"
      contains: "deepgram"
  key_links:
    - from: "push-to-talk.py"
      to: "deepgram_stt.py"
      via: "API key passed to DeepgramSTT constructor"
      pattern: "deepgram_api_key"
---

<objective>
Update dependencies, config schema, and API key loading for Deepgram integration.

Purpose: Ensure the Deepgram SDK is properly pinned, the API key is loadable from environment/config, and configuration options for the new STT subsystem are defined. This is infrastructure wiring that Plan 01 (DeepgramSTT class) and Plan 04 (live_session integration) both depend on.

Output: Updated requirements.txt with proper SDK pin, config additions, API key loading in push-to-talk.py.
</objective>

<execution_context>
@/home/ethan/.claude/get-shit-done/workflows/execute-plan.md
@/home/ethan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK.md — SDK version pin, installation, API key patterns
@.planning/research/PITFALLS.md — Pitfall 11 (SDK version instability), Pitfall 19 (API key management)
@requirements.txt — Current dependencies
@push-to-talk.py — Entry point, API key loading
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update requirements.txt and config</name>
  <files>requirements.txt, config.yaml</files>
  <action>
**requirements.txt changes:**
1. Change `deepgram-sdk>=3.0` to `deepgram-sdk>=5.3,<6.0` -- pins to stable v5 range, avoids v6 breaking changes
2. Keep `faster-whisper` -- it stays as offline fallback (not loaded by default)
3. No other dependency changes needed (onnxruntime, pasimple, numpy all stay)

**config.yaml additions** (add new section if config.yaml exists, or document expected config keys):
Add these keys to the config schema (with defaults):
```yaml
# Deepgram Streaming STT
deepgram:
  idle_timeout: 10          # seconds of silence before switching to KeepAlive
  sleep_timeout: 60         # seconds of KeepAlive before disconnecting
  endpointing_ms: 300       # Deepgram endpointing threshold (ms)
  utterance_end_ms: 1000    # Deepgram utterance end detection (ms)
  daily_budget_cents: 200   # Daily cost cap in cents ($2.00 default)
```

If config.yaml doesn't exist as a formal file, add these as constants in a new config section of deepgram_stt.py or document them as environment variables.

Check the existing config loading pattern in push-to-talk.py to understand how config is structured. Follow the same pattern.
  </action>
  <verify>
  - `grep 'deepgram-sdk>=5.3,<6.0' requirements.txt` returns a match
  - `grep 'faster-whisper' requirements.txt` still returns a match (kept as fallback)
  </verify>
  <done>requirements.txt has deepgram-sdk pinned to >=5.3,<6.0; config has Deepgram-specific settings with sensible defaults</done>
</task>

<task type="auto">
  <name>Task 2: Wire Deepgram API key loading</name>
  <files>push-to-talk.py</files>
  <action>
The Deepgram API key loading already exists in push-to-talk.py (there's an existing `get_deepgram_api_key()` function or similar, referenced in ARCHITECTURE.md line 961: "push-to-talk.py get_deepgram_api_key(), line 126-137"). Read the file to find it.

**Verify the existing loading covers:**
1. `$DEEPGRAM_API_KEY` environment variable
2. `~/.config/deepgram/api_key` file
3. Deepgram SDK auto-reads from env (`DeepgramClient()` without explicit key)

**If the function exists and works:** No changes needed. Verify it passes the key to LiveSession constructor's `deepgram_api_key` parameter.

**If adjustments needed:** Ensure the key is loaded from env or file and passed through to LiveSession. The key must never appear in logs. Follow the existing pattern used for OpenAI API key loading.

**Also verify:** The key is passed through when creating LiveSession. Check that `LiveSession.__init__` accepts `deepgram_api_key` (it already does -- line 190).
  </action>
  <verify>
  - `grep -n 'deepgram' push-to-talk.py` shows API key loading exists
  - `grep -n 'deepgram_api_key' live_session.py` shows it's accepted in __init__
  </verify>
  <done>Deepgram API key is loaded from environment or config file and passed to LiveSession. No secrets appear in logs.</done>
</task>

</tasks>

<verification>
1. `grep 'deepgram-sdk>=5.3,<6.0' requirements.txt` -- version pinned correctly
2. `grep 'faster-whisper' requirements.txt` -- fallback dependency retained
3. Deepgram API key loading path verified in push-to-talk.py
4. `pip install -r requirements.txt` succeeds (in the venv)
</verification>

<success_criteria>
Dependencies are properly pinned, config has Deepgram settings, and the API key loading pipeline works from env/file through to LiveSession constructor.
</success_criteria>

<output>
After completion, create `.planning/phases/12-infrastructure-safety-net/12-02-SUMMARY.md`
</output>
