# Codebase Structure

**Analysis Date:** 2026-02-03

## Directory Layout

```
/home/ethan/projects/push-to-talk/
├── push-to-talk.py                 # Main service: keyboard listener, recording, transcription, AI modes
├── indicator.py                    # Status indicator UI (floating dot or tray)
├── openai_realtime.py              # OpenAI Realtime API client with function calling
├── requirements.txt                # Python dependencies
├── README.md                        # User-facing documentation
├── CLAUDE.md                        # Project-specific instructions
├── vocabulary.txt                  # Custom words for Whisper (user-editable)
├── vocabulary.txt.example          # Template for vocabulary
├── .gitignore                       # Git configuration
├── config.json                      # Runtime config (generated, keybindings, TTS mode)
├── status                           # Status indicator file (generated, transient)
├── install.sh                       # Installation script
├── uninstall.sh                     # Uninstallation script
├── update.sh                        # Update script (git-based)
├── sync.sh                          # Sync script for auto-watcher
├── push-to-talk-watcher.sh          # File change monitoring script
├── push-to-talk.service            # Systemd user service (main)
├── push-to-talk-update.service     # Systemd service (auto-update)
├── push-to-talk-update.timer       # Timer for auto-updates
├── push-to-talk-watcher.service    # Systemd service (file watcher)
└── .planning/
    └── codebase/
        └── ARCHITECTURE.md         # Architecture documentation
```

## Directory Purposes

**Project Root:**
- Purpose: Main entry points and configuration
- Contains: Executable scripts and service definitions
- Key files: `push-to-talk.py` (main), `indicator.py` (UI), `openai_realtime.py` (AI)

**.planning/codebase/**
- Purpose: GSD codebase documentation (generated)
- Contains: Analysis documents (ARCHITECTURE.md, STRUCTURE.md, etc.)
- Key files: Read-only, generated by `/gsd:map-codebase` command

## Key File Locations

**Entry Points:**
- `/home/ethan/projects/push-to-talk/push-to-talk.py`: Main service entry point (line 971, `main()` function)
- `/home/ethan/projects/push-to-talk/indicator.py`: Status indicator entry point (line 1193, `main()` function)
- `/home/ethan/projects/push-to-talk/openai_realtime.py`: Not directly runnable; imported by push-to-talk.py

**Configuration:**
- `/home/ethan/projects/push-to-talk/config.json`: Runtime config (keybindings, TTS backend, AI mode, window position) — created on first run with defaults
- `/home/ethan/projects/push-to-talk/.planning/codebase/`: GSD documentation directory

**Core Logic:**
- `push-to-talk.py` lines 336-969: PushToTalk class (keyboard listener, state machine, recording, transcription, AI)
- `openai_realtime.py` lines 223-527: RealtimeSession class (WebSocket management, audio streaming, function execution)
- `indicator.py` lines 854-1210: StatusIndicator/TrayIndicator classes (UI rendering, status polling)

**Testing:**
- No dedicated test files; service is tested via systemd integration and manual testing

## Naming Conventions

**Files:**
- Main executables: `push-to-talk.py` (hyphenated, Python)
- Supporting modules: `openai_realtime.py` (snake_case, Python)
- UI: `indicator.py`
- Configuration: `config.json` (lowercase)
- Static data: `vocabulary.txt` (lowercase)
- Shell scripts: `*.sh` (installation, update, watching)
- Systemd services: `push-to-talk*.service` (hyphenated)
- Service timers: `push-to-talk*.timer`

**Functions:**
- Class methods: snake_case (e.g., `on_press`, `transcribe_and_type`, `start_recording`)
- Private methods: prefix with underscore (e.g., `_set_status`, `_generate_icon`)
- Callbacks: prefix with `on_` (e.g., `on_press`, `on_release`, `on_draw`, `on_button_press`)

**Variables:**
- Constants: UPPERCASE (e.g., WHISPER_MODEL, PIPER_CMD, COLORS)
- Instance variables: snake_case prefix with `self.` (e.g., `self.recording`, `self.ai_mode`)
- Module-level globals: snake_case or UPPERCASE depending on mutability (e.g., `indicator_process`, `VOCAB_FILE`)

**Types/Classes:**
- PascalCase (e.g., `PushToTalk`, `VocabularyManager`, `RealtimeSession`, `StatusIndicator`, `SettingsWindow`)

**Config keys:**
- snake_case in JSON (e.g., `tts_backend`, `openai_voice`, `ai_mode`, `ptt_key`, `indicator_style`)

## Where to Add New Code

**New Feature - Dictation Enhancement:**
- Primary code: Add methods to `PushToTalk` class in `push-to-talk.py`
- Transcription pipeline: Modify `transcribe_and_type()` (line 548) or add new method
- Vocabulary: Extend `VocabularyManager` class (line 285) if new learning logic needed
- Config: Add key to default config dict (line 153-163) and load in `load_config()`
- Tests: Create `test_push_to_talk.py` (not currently present; recommend adding)

**New Feature - AI Function Calling:**
- Primary code: Add tool to `TOOLS` list in `openai_realtime.py` (lines 34-133)
- Execution: Extend `execute_tool()` function (lines 155-221) with new tool handler
- Config: No config needed; tools are statically defined

**New Feature - UI Setting:**
- Primary code: Add tab or section to `SettingsWindow` in `indicator.py` (lines 128-690)
- Config persistence: Add key to default config (line 54-65), update load/save
- Status communication: If service state affected, update status indicators via `set_status()` call

**New Utility/Helper:**
- Shared helpers: Add to top-level file or create new module (e.g., `audio_utils.py`, `transcription_utils.py`)
- If used by multiple modules, import at top of files
- Constants: Define at module level near imports

**Integration with External API:**
- Primary code: Create new module (e.g., `my_api.py`) or add to `openai_realtime.py` if OpenAI-related
- Error handling: Use try/except with fallback (see lines 27-39, 34-38 for pattern)
- API key management: Store in `~/.config/openai/api_key` (OpenAI pattern) or environment variable
- Config integration: Add entry to config.json schema if user-configurable

## Special Directories

**Runtime Directories (generated, not committed):**

- `~/.local/share/push-to-talk/`: Installation directory for service and venv
  - Generated during install.sh execution
  - Contains: Python venv, push-to-talk.py copy, indicator.py copy, vocabulary.txt copy, config.json
  - Committed: No

- `.git/`: Git repository metadata
  - Auto-syncs to origin on changes (via auto-watcher)
  - Committed: No

- `__pycache__/`: Python bytecode cache
  - Ignored in .gitignore
  - Committed: No

- `.planning/`: GSD planning documents
  - Created by `/gsd:map-codebase` and `/gsd:plan-phase`
  - Committed: No (planning is ephemeral per session)
  - Writable: Yes, new plans overwrite old ones

**Static Directories (part of repo):**
- Project root only; no src/, lib/, or module directories

## Configuration Schema

The `config.json` file stores user settings:

```json
{
  "tts_backend": "piper",          // or "openai"
  "openai_voice": "nova",          // if tts_backend="openai"
  "ai_mode": "claude",             // or "realtime"
  "ptt_key": "ctrl_r",             // Push-to-talk key ID
  "ai_key": "shift_r",             // AI assistant modifier key ID
  "interrupt_key": "escape",       // Interrupt key ID
  "indicator_style": "floating",   // or "tray"
  "indicator_x": 1920,             // Floating indicator X position
  "indicator_y": 1440              // Floating indicator Y position
}
```

Key IDs are defined in MODIFIER_KEY_OPTIONS and INTERRUPT_KEY_OPTIONS dicts (push-to-talk.py lines 114-127).

---

*Structure analysis: 2026-02-03*
